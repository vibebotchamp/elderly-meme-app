<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>é•·è¼©åœ–ç”¢ç”Ÿå™¨ (å®Œç¾ç½®ä¸­ç‰ˆ)</title>
<style>
  /* --- CSS æ¨£å¼ (ä¿æŒä¸è®Š) --- */
  :root {
    --bg-color: #FFF9E1;
    --primary-color: #d32f2f;
  }

  body {
    font-family: 'Microsoft JhengHei', sans-serif;
    background-color: var(--bg-color);
    margin: 0;
    padding: 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    box-sizing: border-box;
  }

  h1 {
    color: var(--primary-color);
    margin: 10px 0 20px 0;
    text-align: center;
    font-size: 1.8rem;
  }

  .app-container {
    width: 100%;
    max-width: 450px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  /* ç•«å¸ƒå®¹å™¨ */
  .canvas-wrapper {
    width: 100%;
    aspect-ratio: 1 / 1;
    border: 8px solid white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    background: #ccc;
    position: relative;
    border-radius: 4px;
    overflow: hidden;
  }

  canvas {
    width: 100%;
    height: 100%;
    display: block;
  }

  #status-msg {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 1.5rem;
    color: #666;
    font-weight: bold;
    pointer-events: none;
    display: none;
  }

  .controls {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  select {
    width: 100%;
    font-size: 1.4rem;
    padding: 12px;
    border: 2px solid var(--primary-color);
    border-radius: 10px;
    background: white;
    color: #333;
    font-weight: bold;
  }

  button {
    width: 100%;
    padding: 15px;
    font-size: 1.4rem;
    font-weight: bold;
    color: white;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    box-shadow: 0 4px 0 rgba(0,0,0,0.2);
  }
  button:active {
    transform: translateY(2px);
    box-shadow: 0 2px 0 rgba(0,0,0,0.2);
  }

  #refresh-btn { background-color: #ff9800; }
  #download-btn { background-color: #2e7d32; }

</style>
</head>
<body>

<div class="app-container">
  <h1>âœ¨ é•·è¼©åœ–ç¥å™¨ âœ¨</h1>

  <div class="canvas-wrapper">
    <div id="status-msg">åœ–ç‰‡è¼‰å…¥ä¸­...</div>
    <canvas id="memeCanvas" width="600" height="600"></canvas>
  </div>

  <div class="controls">
    <select id="category-select"></select>
    <button id="refresh-btn">ğŸ”„ æ›ä¸€å¼µåœ–</button>
    <button id="download-btn">â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡</button>
  </div>
</div>

<script>
  // 1. è³‡æ–™åº«
  const memeData = {
    "æ—©å®‰": { keyword: "morning,nature", phrases: ["æ—©å®‰ï¼ç¾å¥½çš„ä¸€å¤©", "å¹³å®‰å–œæ¨‚", "ç¥æ‚¨é †å¿ƒå¦‚æ„", "æ—©å®‰ï¼Œè¨˜å¾—åƒæ—©é¤", "å¥åº·æ˜¯ç¦"] },
    "æ™šå®‰": { keyword: "night,stars", phrases: ["æ™šå®‰ï¼Œå¥½å¤¢é€£é€£", "è¾›è‹¦äº†ï¼Œæ—©é»ä¼‘æ¯", "ç¥ä½ æœ‰å€‹å¯§éœçš„å¤œæ™š", "ç¡å€‹å¥½è¦ºï¼Œæ˜å¤©æ›´å¥½"] },
    "ç”Ÿæ—¥å¿«æ¨‚": { keyword: "cake,party", phrases: ["ç¥ä½ ç”Ÿæ—¥å¿«æ¨‚ï¼", "ç”Ÿæ—¥å¤§å‰ï¼Œç¦å¦‚æ±æµ·", "å¤©å¤©é–‹å¿ƒï¼Œç”Ÿæ—¥æ„‰å¿«", "é¡˜æ‚¨é’æ˜¥æ°¸é§"] },
    "æ–°å¹´å¿«æ¨‚": { keyword: "red,lantern", phrases: ["æ–°å¹´å¿«æ¨‚ï¼Œæ­¥æ­¥é«˜å‡", "è¬äº‹å¦‚æ„ï¼Œå¤§å‰å¤§åˆ©", "æ­å–œç™¼è²¡ï¼Œç´…åŒ…æ‹¿ä¾†", "é´»é‹ç•¶é ­"] },
    "é™¤å¤•": { keyword: "dinner,family", phrases: ["é™¤å¤•åœ˜åœ“ï¼Œå…¨å®¶å¹³å®‰", "è¾­èˆŠè¿æ–°ï¼Œå¥½é‹å¹´å¹´", "å¹´å¤œé£¯é¦™ï¼Œå¹¸ç¦æ»¿å ‚"] },
    "åˆä¸€": { keyword: "temple,gold", phrases: ["å¤§å¹´åˆä¸€èµ°æ˜¥æ‹œå¹´", "æ­å–œç™¼è²¡ç¬‘å“ˆå“ˆ", "é–‹æ˜¥å¤§å‰å¥½å…†é ­", "åˆä¸€ç´…åŒ…è³ºå¤§éŒ¢"] },
    "åˆäºŒ": { keyword: "gift,home", phrases: ["åˆäºŒå›å¨˜å®¶", "å–œæ…¶æ»¿å…¨å®¶", "å¥½äº‹æˆé›™", "å›é–€å¤§å‰"] },
    "åˆä¸‰": { keyword: "sleep,bed", phrases: ["åˆä¸‰ç¡åˆ°é£½", "å¥åº·æ²’ç…©æƒ±", "åˆä¸‰å®‰ç©©", "å¯Œè²´æ»¿é–€"] },
    "åˆå››": { keyword: "money,god", phrases: ["åˆå››æ¥è²¡ç¥", "ç¥å…‰æ™®ç…§", "å…¨å®¶å®‰åº·", "æ•´å¹´ç™¼ç™¼ç™¼"] },
    "åˆäº”": { keyword: "open,work", phrases: ["åˆäº”é–‹å·¥å¤§å‰", "äº”ç¦è‡¨é–€", "è²¡æºå»£é€²", "ç”Ÿæ„èˆˆéš†"] },
    "åˆå…­": { keyword: "road,go", phrases: ["åˆå…­å¤§é †", "è¬äº‹äº¨é€š", "å…­å…­å¤§é †", "å¹³å®‰å‡ºè¡Œ"] }
  };

  const canvas = document.getElementById('memeCanvas');
  const ctx = canvas.getContext('2d');
  const statusMsg = document.getElementById('status-msg');
  const categorySelect = document.getElementById('category-select');
  
  let currentCategory = "æ—©å®‰";
  let currentText = "";

  // åˆå§‹åŒ–é¸å–®
  Object.keys(memeData).forEach(key => {
    let opt = document.createElement('option');
    opt.value = key;
    opt.textContent = key;
    categorySelect.appendChild(opt);
  });

  categorySelect.addEventListener('change', (e) => {
    currentCategory = e.target.value;
    generateContent();
  });
  
  document.getElementById('refresh-btn').addEventListener('click', generateContent);
  document.getElementById('download-btn').addEventListener('click', downloadImage);

  generateContent();

  function generateContent() {
    statusMsg.style.display = 'block';
    
    const data = memeData[currentCategory];
    currentText = data.phrases[Math.floor(Math.random() * data.phrases.length)];
    
    const img = new Image();
    img.crossOrigin = "Anonymous"; 
    
    const timeoutId = setTimeout(() => {
        console.log("åœ–ç‰‡è¼‰å…¥å¤ªæ…¢ï¼Œåˆ‡æ›ç‚ºç´”è‰²èƒŒæ™¯");
        drawCanvas(null);
    }, 3000);

    img.onload = function() {
      clearTimeout(timeoutId);
      drawCanvas(img);
    };

    img.onerror = function() {
      clearTimeout(timeoutId);
      drawCanvas(null);
    };

    const randomSeed = Math.floor(Math.random() * 9999);
    img.src = `https://picsum.photos/seed/${randomSeed}/600/600?${data.keyword}`;
  }

  // --- æ”¹é€²å¾Œçš„ç¹ªåœ–é‚è¼¯ (æ ¸å¿ƒä¿®æ­£å€) ---
  function drawCanvas(imgSource) {
    // 1. ç•«èƒŒæ™¯
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (imgSource) {
      ctx.drawImage(imgSource, 0, 0, canvas.width, canvas.height);
      ctx.fillStyle = "rgba(0, 0, 0, 0.2)"; // é®ç½©
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    } else {
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, "#ff9a9e");
      gradient.addColorStop(1, "#fecfef");
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // 2. æº–å‚™æ–‡å­—åƒæ•¸
    // æ ¹æ“šç•«å¸ƒå¯¬åº¦è¨­å®šæœ€å¤§æ–‡å­—å¯¬åº¦ (å·¦å³å„ç•™ 40px é‚Šè·)
    const maxTextWidth = canvas.width - 80; 
    let fontSize = 80; // é è¨­å­—é«”å¤§å°
    ctx.font = `900 ${fontSize}px "Microsoft JhengHei", sans-serif`;
    
    // 3. è‡ªå‹•æ›è¡Œè¨ˆç®— (Smart Wrapping)
    let lines = getLines(ctx, currentText, maxTextWidth);
    
    // å¦‚æœè¡Œæ•¸å¤ªå¤šï¼Œå°è‡´å¤ªé«˜ï¼Œè‡ªå‹•ç¸®å°å­—é«”å†ç®—ä¸€æ¬¡
    // å‡è¨­è¶…é 3 è¡Œå°±ç¸®å°å­—é«”
    if (lines.length > 3) {
        fontSize = 60;
        ctx.font = `900 ${fontSize}px "Microsoft JhengHei", sans-serif`;
        lines = getLines(ctx, currentText, maxTextWidth);
    }

    // 4. è¨ˆç®—å‚ç›´ç½®ä¸­ä½ç½®
    const lineHeight = fontSize * 1.3; // è¡Œé«˜è¨­ç‚ºå­—é«”çš„ 1.3 å€
    const totalTextHeight = lines.length * lineHeight;
    // èµ·å§‹ Y åº§æ¨™ = (ç•«å¸ƒé«˜åº¦ - æ–‡å­—ç¸½é«˜åº¦) / 2 + (ç¬¬ä¸€è¡Œçš„èª¿æ•´)
    // é€™è£¡åŠ ä¸Š lineHeight / 2 æ˜¯å› ç‚º textBaseline = 'middle'
    let startY = (canvas.height - totalTextHeight) / 2 + (lineHeight / 2);

    // 5. é–‹å§‹ç¹ªè£½æ¯ä¸€è¡Œ
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.strokeStyle = "black";
    ctx.lineWidth = 8;
    ctx.lineJoin = "round";
    ctx.fillStyle = "#FFFF00"; // é»ƒè‰²å­—

    for (let i = 0; i < lines.length; i++) {
        const y = startY + (i * lineHeight);
        // å…ˆç•«é»‘é‚Š
        ctx.strokeText(lines[i], canvas.width / 2, y);
        // å†ç•«é»ƒå­—
        ctx.fillText(lines[i], canvas.width / 2, y);
    }

    statusMsg.style.display = 'none';
  }

  // è¼”åŠ©å‡½å¼ï¼šè¨ˆç®—æ–‡å­—è©²æ€éº¼æ›è¡Œ
  function getLines(ctx, text, maxWidth) {
    let words = text.split(''); // æŠŠå­—ä¸²åˆ‡æˆä¸€å€‹å€‹å­—
    let lines = [];
    let currentLine = words[0];

    for (let i = 1; i < words.length; i++) {
        let word = words[i];
        let width = ctx.measureText(currentLine + word).width;
        if (width < maxWidth) {
            currentLine += word;
        } else {
            lines.push(currentLine);
            currentLine = word;
        }
    }
    lines.push(currentLine);
    return lines;
  }

  function downloadImage() {
    try {
        const link = document.createElement('a');
        link.download = `é•·è¼©åœ–-${Date.now()}.jpg`;
        link.href = canvas.toDataURL("image/jpeg", 0.9);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } catch (e) {
        alert("ä¸‹è¼‰å¤±æ•—ï¼Œè«‹å˜—è©¦é•·æŒ‰åœ–ç‰‡å„²å­˜ã€‚");
    }
  }
</script>

</body>
</html>
